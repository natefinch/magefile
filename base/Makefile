###############################################################################
####################### <github.com/aszdrick/magefile> ########################
############################ <aszdrick@gmail.com> #############################
###############################################################################

# Copyright (c) 2017 Marleson Graf

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

################################# DIRECTORIES #################################
SRCDIR :=src
INCDIR :=include
OBJDIR :=build
BINDIR :=bin
TSTDIR :=tests
DEPDIR :=.deps
############################ PROJECT CONFIGURATION ############################
SUFFIXES  :=.h .hpp .cpp
# Compiler & linker flags
CXXFLAGS  :=-std=c++14 -Wall
LDFLAGS   :=
LDLIBS    :=
INCLUDE   :=-I$(INCDIR)
# Files
MAINFILES :=src/main.cpp
PROGRAMS  :=$(BINDIR)/execute_me
MAINDEPS  :=$(patsubst %.cpp,$(DEPDIR)/%.mk,$(MAINFILES))
SOURCES   :=$(shell find $(SRCDIR) -name '*.cpp' 2> /dev/null)
OBJECTS   :=$(patsubst %.cpp,$(OBJDIR)/%.o,$(SOURCES))
DEPS      :=$(patsubst %.cpp,$(DEPDIR)/%.d,$(SOURCES))
CALLS     :=$(notdir $(PROGRAMS))
############################# TESTS CONFIGURATION #############################
# Compiler & linker flags for tests
TCXXFLAGS  :=
TLDFLAGS   :=
TLDLIBS    :=
TINCLUDE   :=
# Files
TMAINFILES :=$(wildcard $(TSTDIR)/*.cpp)
TPROGRAMS  :=$(patsubst $(TSTDIR)/%.cpp,$(BINDIR)/%,$(TMAINFILES))
TMAINDEPS  :=$(patsubst %.cpp,$(DEPDIR)/%.mk,$(TMAINFILES))
TSOURCES   :=$(shell find $(TSTDIR) -name '*.cpp' 2> /dev/null)
TOBJECTS   :=$(patsubst %.cpp,$(OBJDIR)/%.o,$(TSOURCES))
TDEPS      :=$(patsubst %.cpp,$(DEPDIR)/%.d,$(TSOURCES))
TCALLS     :=$(notdir $(TPROGRAMS))
################################ MISCELLANEOUS ################################
# Debug flag, deactivates all supressed echoing
DEBUG   :=0
# Autogenerated directories
MAKEDIR :=$(BINDIR) $(SRCDIR) $(INCDIR)
# Command to print status messages
MPRINT  :=@echo
# If DEBUG is not active (i.e, equals 1), set supressing character (@)
ifeq ($(DEBUG),0)
SILENT  :=@
endif
# Multiline variable with all commands to generate .mk files for each main file
# Arguments: file to be written, file to read of, target file, objects variable
# name, dependencies variable name
define make_main_deps
	$(eval $(4):=$(filter $(addprefix %,$(SUFFIXES)),$(shell cat $(2))))
	$(eval $(4):=$(basename $($(4))))
	$(eval $(4):=$(patsubst $(INCDIR)/%,$(SRCDIR)/%,$($(4))))
	$(eval $(4):=$(patsubst %,$(OBJDIR)/%.o,$($(4))))
	$(eval $(4):=$(filter $($(4)),$(OBJECTS) $(TOBJECTS)))
	$(eval $(5):=$(patsubst $(OBJDIR)/%.o,$(DEPDIR)/%.d,$($(4))))
	$(file > $(1),$(4) :=$($(4)))
	$(file >> $(1),$(3): $$($(4)))
	$(file >> $(1),-include $($(5)))
endef

MAINEXECVARS :=$(basename $(notdir $(MAINFILES) $(TMAINFILES)))
MAINEXECVARS :=$(addsuffix _EXEC:=,$(MAINEXECVARS))
MAINEXECVARS :=$(join $(MAINEXECVARS), $(PROGRAMS) $(TPROGRAMS))
$(foreach var,$(MAINEXECVARS),$(eval $(var)))

.PHONY: all makedir clean distclean tests $(TCALLS)

################################# MAIN RULES ##################################
all: makedir $(PROGRAMS)

$(foreach target,$(CALLS) $(TCALLS),$(eval $(target): $(BINDIR)/$(target)))

$(PROGRAMS) $(TPROGRAMS): | $(BINDIR)
	$(MPRINT) "[linking] $@"
	$(SILENT) $(CXX) $(CXXFLAGS) $(LDFLAGS) $(INCLUDE) \
	$($(@F)_OBJS) $(LDLIBS) -o $@

$(OBJDIR)/%.o: %.cpp
	$(MPRINT) "[  $(CXX)  ] $< -> .o"
	$(SILENT) mkdir -p $(OBJDIR)/$(*D)
	$(SILENT) $(CXX) $(CXXFLAGS) $(INCLUDE) -c $< -o $@

$(DEPDIR)/%.d: %.cpp
	$(MPRINT) "[makedep] $< -> .d"
	$(SILENT) mkdir -p $(DEPDIR)/$(*D)
	$(SILENT) $(CXX) $(CXXFLAGS) $(INCLUDE) -MM -MP -MG \
	-MT "$(OBJDIR)/$*.o $@" -MF "$@" $<

$(MAINDEPS) $(TMAINDEPS): %.mk: %.d
	$(MPRINT) "[makedep] $< -> .mk"
	$(SILENT) mkdir -p $(*D)
	$(eval OBJS_LABEL=$(notdir $($(*F)_EXEC))_OBJS)
	$(eval DEPS_LABEL=$(notdir $($(*F)_EXEC))_DEPS)
	$(call make_main_deps,$@,$^,$($(*F)_EXEC),$(OBJS_LABEL),$(DEPS_LABEL))

makedir: | $(MAKEDIR)

$(MAKEDIR):
	$(MPRINT) "[ mkdir ] Creating directory '$@'"
	$(SILENT) mkdir -p $@

################################ TESTS RULES ##################################
tests: makedir $(TPROGRAMS)

$(TPROGRAMS): LDLIBS +=$(TLDLIBS)

$(TPROGRAMS): LDFLAGS +=$(TLDFLAGS)

$(OBJDIR)/$(TSTDIR)/%.o: CXXFLAGS +=$(TCXXFLAGS)

$(OBJDIR)/$(TSTDIR)/%.o: INCLUDE +=$(TINCLUDE)

################################ CLEAN RULES ##################################
# Only remove object files
clean:
	$(SILENT) $(RM) -r $(OBJDIR)
	$(SILENT) $(RM) -r $(BINDIR)

# Remove object, binary and dependency files
distclean: clean
	$(SILENT) $(RM) -r $(DEPDIR)

################################ PREREQUISITES ################################
# Do not include list of dependencies with clean rules
ifeq ($(filter-out all $(CALLS) $(PROGRAMS),$(MAKECMDGOALS)),)
  -include $(MAINDEPS)
else
  ifneq ($(filter tests $(TCALLS) $(TPROGRAMS),$(MAKECMDGOALS)),)
    -include $(TMAINDEPS)
  endif
endif
