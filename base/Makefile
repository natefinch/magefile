###############################################################################
###################### <github.com/aszdrick/magefile/> ########################
############################ <aszdrick@gmail.com> #############################
###############################################################################

# Copyright (c) 2017 Marleson Graf

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

################################# DIRECTORIES #################################
SRCDIR :=src
INCDIR :=include
OBJDIR :=build
BINDIR :=bin
TSTDIR :=tests
DEPDIR :=.deps
############################ PROJECT CONFIGURATION ############################
# Compiler & linker flags
CXXFLAGS :=-Wall
LDFLAGS  :=
LDLIBS   :=
INCLUDE  :=-I$(INCDIR)
# Files
MAINFILE :=main
PROGRAM  :=$(BINDIR)/execute_me
SOURCES  :=$(shell find $(SRCDIR) -name '*.cpp' 2> /dev/null)
DEPS     :=$(patsubst %.cpp,$(DEPDIR)/%.d,$(SOURCES))
OBJECTS  :=$(patsubst %.cpp,$(OBJDIR)/%.o,$(SOURCES))
############################# TESTS CONFIGURATION #############################
# Compiler & linker flags for tests
TCXXFLAGS  :=
TLDFLAGS   :=
TLDLIBS    :=
TINCLUDE   :=
# Files
TMAINFILES :=$(wildcard $(TSTDIR)/*.cpp)
TMAINDEPS  :=$(patsubst %.cpp,$(DEPDIR)/%.mk,$(TMAINFILES))
TSOURCES   :=$(shell find $(TSTDIR) -name '*.cpp' 2> /dev/null)
TOBJECTS   :=$(patsubst %.cpp,$(OBJDIR)/%.o,$(TSOURCES))
TDEPS      :=$(patsubst %.cpp,$(DEPDIR)/%.d,$(TSOURCES))
TPROGRAMS  :=$(patsubst $(TSTDIR)/%.cpp,$(BINDIR)/%,$(TMAINFILES))
TCALLS     :=$(patsubst $(TSTDIR)/%.cpp,%,$(TMAINFILES))
################################ MISCELLANEOUS ################################
# Debug flag, deactivates all supressed echoing
DEBUG   :=0
# Autogenerated directories
MAKEDIR :=$(BINDIR) $(SRCDIR) $(INCDIR)
# Command to print status messages
MPRINT  :=@echo
# If DEBUG is not active (i.e, equals 1), set supressing character (@)
ifeq ($(DEBUG),0)
SILENT  :=@
endif
# Multiline variable with all commands to generate .mk files for each main file
define MAKE_MAIN_DEPS
	$(eval TEMP:=$(filter %.h %.hpp %.cpp,$(shell cat $*.d)))
	$(eval TEMP:=$(patsubst $(INCDIR)/%.hpp,$(SRCDIR)/%.cpp,$(TEMP)))
	$(eval TEMP:=$(patsubst %.cpp,$(OBJDIR)/%.o,$(TEMP)))
	$(eval TEMP:=$(filter $(TEMP),$(OBJECTS) $(TOBJECTS)))
	$(eval $(*F)_DEPS:=$(patsubst $(OBJDIR)/%.o,$(DEPDIR)/%.d,$(TEMP)))
	$(file > $@,$(*F)_OBJS :=$(TEMP))
	$(file >> $@,$$(BINDIR)/$(*F): $$($(*F)_OBJS))
	$(file >> $@,-include $($(*F)_DEPS))
endef

.PHONY: all makedir clean clean-all tests $(TCALLS)

################################# MAIN RULES ##################################
all: makedir $(PROGRAM)

$(PROGRAM): $(OBJECTS) | $(BINDIR)
	$(MPRINT) "[linking] $@"
	$(SILENT) $(CXX) $(CXXFLAGS) $(LDFLAGS) $(OBJECTS) $(LDLIBS) -o $@

$(OBJDIR)/%.o: %.cpp
	$(MPRINT) "[  $(CXX)  ] $< -> .o"
	$(SILENT) mkdir -p $(OBJDIR)/$(*D)
	$(SILENT) $(CXX) $(CXXFLAGS) $(INCLUDE) -c $< -o $@

$(DEPDIR)/%.d: %.cpp
	$(MPRINT) "[makedep] $< -> .d"
	$(SILENT) mkdir -p $(DEPDIR)/$(*D)
	$(SILENT) $(CXX) $(CXXFLAGS) $(INCLUDE) -MM -MP -MG \
	-MT "$(OBJDIR)/$*.o $@" -MF "$@" $<

makedir: | $(MAKEDIR)

$(MAKEDIR):
	$(MPRINT) "[ mkdir ] Creating directory '$@'"
	$(SILENT) mkdir -p $@

################################ TESTS RULES ##################################
tests: makedir $(TPROGRAMS)

$(foreach t,$(TCALLS),$(eval $(NEWLINE)$(t): $(BINDIR)/$(t)))

$(TPROGRAMS): LDLIBS +=$(TLDLIBS)

$(TPROGRAMS): LDFLAGS +=$(TLDFLAGS)

$(OBJDIR)/$(TSTDIR)/%.o: CXXFLAGS +=$(TCXXFLAGS)

$(OBJDIR)/$(TSTDIR)/%.o: INCLUDE +=$(TINCLUDE)

$(TPROGRAMS): | $(BINDIR)
	$(MPRINT) "[linking] $@"
	$(SILENT) $(CXX) $(CXXFLAGS) $(LDFLAGS) $(INCLUDE) \
	$($(@F)_OBJS) $(LDLIBS) -o $@

$(TMAINDEPS): %.mk: %.d
	$(MPRINT) "[makedep] $< -> .mk"
	$(SILENT) mkdir -p $(*D)
	$(MAKE_MAIN_DEPS)

################################ CLEAN RULES ##################################
# Only remove object files
clean: $(MCLEAN)
	$(SILENT) $(RM) -r $(OBJDIR)

# Remove object, binary and dependency files
clean-all: clean $(MCLNALL)
	$(SILENT) $(RM) -r $(BINDIR)
	$(SILENT) $(RM) -r $(DEPDIR)

################################ PREREQUISITES ################################
# Do not include list of dependencies with clean rules
ifeq ($(filter clean clean-all,$(MAKECMDGOALS)),)
  ifneq ($(filter tests $(TCALLS) $(TPROGRAMS),$(MAKECMDGOALS)),)
    -include $(TMAINDEPS)
  else
    -include $(DEPS)
  endif
endif
